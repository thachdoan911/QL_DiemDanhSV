-- DATABASE QL_DIEMDANHSV --
CREATE DATABASE QL_DIEMDANHSV
GO
USE QL_DIEMDANHSV 
GO

-- TABLE --

CREATE TABLE GIANGVIEN (
	MAGV NVARCHAR (15) NOT NULL,
	HOTENGV NVARCHAR (50) NOT NULL,
	NGAYSINH DATE,
	DIACHI NVARCHAR(50)
	CONSTRAINT PK_GIAOVIEN PRIMARY KEY (MAGV)
)

CREATE TABLE LOP (
	MALOP NVARCHAR (15) NOT NULL,
	MAGV NVARCHAR(15) NOT NULL,
	TENLOP NVARCHAR (50) NOT NULL,
	SISO INT
	CONSTRAINT PK_LOP PRIMARY KEY (MALOP)
)
 
CREATE TABLE SINHVIEN (
	MASV NVARCHAR (15) NOT NULL,
	HOTENSV NVARCHAR (50) NOT NULL,
	NGAYSINH DATE,
	PHAI NVARCHAR(5),
	DIACHI NVARCHAR (50),
	MALOP NVARCHAR(15)
	CONSTRAINT PK_SINHVIEN PRIMARY KEY (MASV)
)

CREATE TABLE GV_DIEMDANH (
	MADD NVARCHAR(15) NOT NULL,
	MAGV NVARCHAR(15) NOT NULL,
	MASV NVARCHAR (15) NOT NULL,
	MALOP NVARCHAR (15) NOT NULL,
	NGAYDIEMDANH DATE,
	SOTIETVANG INT,
	LYDOVANG NVARCHAR (50)
	CONSTRAINT PK_DD PRIMARY KEY (MADD)
)
CREATE TABLE CHITIETDIEMDANH (
	MASV NVARCHAR (15) NOT NULL,
	MALOP NVARCHAR (15)NOT NULL,
	SOTIETCOPHEP INT,
	SOTIETKHONGPHEP INT,
	TONGSOLANVANG INT,
	LYDOVANG NVARCHAR (50),
	XULYHOCVU NVARCHAR (20)
	)


CREATE TABLE DANGNHAP (
	USERNAME NVARCHAR(50) NOT NULL,
	PASS NVARCHAR (120) NOT NULL,
	QUYENTRUYCAP INT NULL,
	CONSTRAINT PK_DANGNHAP PRIMARY KEY (USERNAME)
)

-- RÀNG BUỘC KHÓA NGOẠI -- 
----------------------------
-- BẢNG SINH VIEN --
ALTER TABLE SINHVIEN
ADD CONSTRAINT FK_SINHVIEN_LOP FOREIGN KEY (MALOP) REFERENCES LOP (MALOP)

-- BẢNG LOP --
ALTER TABLE LOP
ADD CONSTRAINT FK_LOP_GIANGVIEN FOREIGN KEY (MAGV) REFERENCES GIANGVIEN (MAGV)

-- BẢNG GV_DIEMDANH --
ALTER TABLE GV_DIEMDANH
ADD CONSTRAINT FK_GVDIEMDANH_GV FOREIGN KEY (MAGV) REFERENCES GIANGVIEN (MAGV)
ALTER TABLE GV_DIEMDANH
ADD CONSTRAINT FK_GVDIEMDANH_SV FOREIGN KEY (MASV) REFERENCES SINHVIEN (MASV)
ALTER TABLE GV_DIEMDANH
ADD CONSTRAINT FK_GVDIEMDANH_LOP FOREIGN KEY (MALOP) REFERENCES LOP (MALOP)

-- BẢNG CHITIETDIEMDANH --
ALTER TABLE CHITIETDIEMDANH
ADD CONSTRAINT FK_CHITIETDD_SV FOREIGN KEY (MASV) REFERENCES SINHVIEN (MASV)
ALTER TABLE CHITIETDIEMDANH
ADD CONSTRAINT FK_CHITIETDD_LOP FOREIGN KEY (MALOP) REFERENCES LOP (MALOP)



--- NHẬP LIỆU VÀO BẢNG ---
SET DATEFORMAT DMY
INSERT INTO GIANGVIEN(MAGV,HOTENGV,NGAYSINH,DIACHI) 
VALUES 
	('GV001',N'Nguyễn Thị Thu Hà','10/5/1980','TP.HCM'),
	('GV002',N'Trần Anh Tuấn','20/8/1985',N'Hải Phòng'),
	('GV003',N'Lê Thị Thủy','05/07/2000',N'Cần Thơ'),
	('GV004',N'Nguyễn Thị Ánh Tuyết','17/07/2002',N'Đà Nẵng'),
	('GV005',N'Nguyễn Duy Bình','08/03/2001',N'Kiên Giang'),
	('GV006',N'Thái Văn Minh','15/4/1995',N'Nghệ An');

INSERT INTO LOP(MALOP,MAGV,TENLOP,SISO)
VALUES
	('LOP_01','GV002',N'Công Nghệ Thông Tin 08',4),
	('LOP_02','GV006',N'Công Nghệ Thông Tin 10',2),
	('LOP_03','GV004',N'Anh Văn 03',2),
	('LOP_04','GV004',N'Tài Chính Kế Toán 01',2),
	('LOP_05','GV005',N'Công Nghệ May 01',4),
	('LOP_06','GV006',N'Công Nghệ Thực Phẩm 01',2),
	('LOP_07','GV001',N'Ngôn Ngữ Anh 03',2),
	('LOP_08','GV003',N'Tài Chính Kế Toán 02',2)

SET DATEFORMAT DMY
INSERT INTO SINHVIEN(MASV,HOTENSV,NGAYSINH,PHAI,DIACHI,MALOP)
VALUES 
	('SV001',N'Nguyễn An','09-12-2002',N'Nam',N'TP.HCM','LOP_01'),
	('SV002',N'Trần Bình','22-02-2002',N'Nam',N'Vũng Tàu','LOP_01'),
	('SV003',N'Huỳnh Thị Diễm','12-10-2001',N'Nữ',N'Khánh Hòa','LOP_04'),
	('SV004',N'Nguyễn Văn Đậu','28-07-2001',N'Nam',N'Long An','LOP_06'),
	('SV005',N'Trần Như Lệ','21-09-2002',N'Nữ',N'Vũng Tàu','LOP_08'),
	('SV006',N'Nguyễn Văn Lộc','05-11-2001',N'Nam',N'Bình Thuận','LOP_05'),
	('SV007',N'Phan Gia Thùy','18-04-2002',N'Nữ',N'Phú Yên','LOP_01'),
	('SV008',N'Đoàn Lê Nhật','27-12-2002',N'Nam',N'Nha Trang','LOP_07'),
	('SV009',N'Nguyễn Thùy Dương','29-12-2003',N'Nữ',N'Ninh Thuận','LOP_02'),
	('SV010',N'Nguyễn Văn Minh','01-11-2000',N'Nam',N'TP.HCM','LOP_03'),
	('SV011',N'Nguyễn Hùng Vương','02-12-2002',N'Nam',N'TP.HCM','LOP_03'),
	('SV012',N'Trần Mạc Phong','22-06-2002',N'Nam',N'ĐắkLắk','LOP_05'),
	('SV013',N'Hoàng Thị Thảo Nguyên','12-08-2001',N'Nữ',N'Đồng Nai','LOP_05'),
	('SV014',N'Dương Bảo An','09-07-2001',N'Nam',N'Tiền Giang','LOP_02'),
	('SV015',N'Phùng Thị Hoàng Anh','20-11-2002',N'Nữ',N'Bình Thuận','LOP_08'),
	('SV016',N'Thái Hoàng Huy','05-02-2001',N'Nam',N'Cà Mau','LOP_05'),
	('SV017',N'Hồ Ngọc Huyền Trân','17-07-2002',N'Nữ',N'Quãng Trị','LOP_01'),
	('SV018',N'Nguyễn Văn Hoàng Khang','27-04-2002',N'Nam',N'Nha Trang','LOP_04'),
	('SV019',N'Nguyễn Thị Hồng Trinh','12-12-2003',N'Nữ',N'Ninh Thuận','LOP_06'),
	('SV020',N'Nguyễn Tuấn Anh','11-11-2000',N'Nam',N'TP.HCM','LOP_07')

SET DATEFORMAT DMY
INSERT INTO GV_DIEMDANH (MADD,MAGV,MASV,MALOP,NGAYDIEMDANH,SOTIETVANG,LYDOVANG)
VALUES
	('DD01','GV001','SV018','LOP_04','14/2/2022',1,N'Bị sốt'),
	('DD02','GV001','SV020','LOP_07','22/2/2022',1,N'Bận việc gia đình'),
	('DD03','GV002','SV002','LOP_01','12/2/2022',3,N'Không rõ'),
	('DD04','GV003','SV005','LOP_08','23/3/2022',2,N'Ngủ quên'),
	('DD05','GV003','SV006','LOP_05','11/2/2022',1,N'Xe hư'),
	('DD06','GV004','SV011','LOP_03','15/2/2022',0,NULL),
	('DD07','GV005','SV012','LOP_05','17/2/2022',0,NULL),
	('DD08','GV006','SV014','LOP_02','19/2/2022',5,N'Không rõ'),
	('DD09','GV006','SV004','LOP_06','28/2/2022',2,N'Bể bánh xe'),
	('DD010','GV006','SV016','LOP_05','25/2/2022',0,NULL)

INSERT INTO CHITIETDIEMDANH(MASV,MALOP,SOTIETCOPHEP,SOTIETKHONGPHEP,TONGSOLANVANG,LYDOVANG,XULYHOCVU)
VALUES
	('SV018','LOP_04',1,0,1,N'Bị sốt',N'Được thi'),
	('SV011','LOP_03',0,0,0,NULL,N'Được thi'),
	('SV006','LOP_05',1,0,1,N'Xe hư',N'Được thi'),
	('SV014','LOP_02',0,5,5,N'Không rõ',N'Cấm thi'),
	('SV016','LOP_05',0,0,0,NULL,N'Được thi'),
	('SV005','LOP_08',0,2,2,N'Ngủ quên',N'Được thi'),
	('SV002','LOP_01',0,3,3,N'Không rõ',N'Cấm thi'),
	('SV020','LOP_07',1,0,1,N'Bận việc gia đình',N'Được thi'),
	('SV012','LOP_05',0,0,0,NULL,N'Được thi'),
	('SV004','LOP_06',2,0,2,N'Bể bánh xe',N'Được thi')

-- LOGIN --

INSERT INTO DANGNHAP (USERNAME,PASS,QUYENTRUYCAP) 
VALUES 
	('ha','ha123',1),
	('tuan','tuan123',1),
	('thuy','thuy123',1),
	('ducadmin','ducnguyen',0),
	('tuyet','tuyet123',1),
	('binh','binh123',1),
	('minhn','minh123',1)

	----1/ Khi thêm sửa xóa sinh viên thì ở bảng lớp sẽ cập nhật lại sĩ số.
CREATE TRIGGER CAPNHAT ON SINHVIEN
AFTER INSERT,UPDATE,DELETE 
AS
BEGIN 
	UPDATE LOP
	SET SISO = (SELECT COUNT(*) FROM SINHVIEN WHERE LOP.MALOP =SINHVIEN.MALOP)
END

DROP TRIGGER CAPNHAT

---- 2 Viết trigger kiểm tra giới tính ----
CREATE TRIGGER CHECKGENDER ON SINHVIEN
FOR INSERT,UPDATE 
AS
BEGIN
	IF (SELECT COUNT(PHAI) FROM inserted WHERE PHAI NOT IN (N'NAM',N'NỮ', N'KHÁC')) > 0
	BEGIN
		PRINT N' YÊU CẦU GIỚI TÍNH PHẢI LÀ 1 TRONG CÁC GIÁ TRỊ N"NAM, N"NỮ", N"KHÁC" ' 
	END
END
-- 3 Khi sửa SOTIETVANG ở bảng GV_DIEMDANH thì cập nhật lại TONGSOLANVANG ở bảng CHITIETDIEMDANH (test lỗi )
CREATE TRIGGER TRG_TONGVANG ON GV_DIEMDANH
AFTER INSERT AS
BEGIN
	UPDATE CHITIETDIEMDANH
	SET TONGSOLANVANG = TONGSOLANVANG - (
	SELECT SOTIETVANG FROM inserted WHERE MASV = CHITIETDIEMDANH.MASV)
	FROM CHITIETDIEMDANH
	JOIN inserted ON CHITIETDIEMDANH.MASV = inserted.MASV
	END

	drop trigger trg_tongvang
	
-- 4 Khi thao tác trên lý do vắng trên bảng GV_DIEMDANH sẽ cập nhật lý do vắng trên bảng CHITIETDIEMDANH -- (lỗi)
CREATE TRIGGER CAPNHATLYDO ON GV_DIEMDANH
FOR INSERT,UPDATE,DELETE
AS
BEGIN
	UPDATE CHITIETDIEMDANH
	SET LYDOVANG = (SELECT LYDOVANG FROM GV_DIEMDANH WHERE GV_DIEMDANH.MASV=CHITIETDIEMDANH.MASV)
END

